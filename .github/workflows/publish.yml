name: Publish crates

on:
    push:
        tags:
            - "v*"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

jobs:
    publish:
        name: Publish to crates.io
        runs-on: ubuntu-latest
        permissions:
            contents: read
        defaults:
            run:
                shell: bash
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Ensure tag commit is on main
              id: ensure-main
              run: |
                  set -euo pipefail
                  git fetch origin main --depth=1
                  if git merge-base --is-ancestor HEAD origin/main; then
                      echo "on_main=true" >> "$GITHUB_OUTPUT"
                  else
                      echo "on_main=false" >> "$GITHUB_OUTPUT"
                      echo "Tag is not pointing to main; skipping publish."
                  fi

            - name: Build workspace
              if: steps.ensure-main.outputs.on_main == 'true'
              run: |
                  set -euo pipefail
                  cargo build --release --workspace

            - name: Publish crates
              if: steps.ensure-main.outputs.on_main == 'true'
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
              run: |
                  set -euo pipefail

                  crates=(crates/crypto crates/rpc sdk)

                  for crate_path in "${crates[@]}"; do
                      echo "::group::Publishing ${crate_path}"
                      pushd "$crate_path" >/dev/null

                      read -r NAME VERSION <<<"$(cargo metadata --no-deps --format-version 1 --locked | jq -r --arg manifest "$PWD/Cargo.toml" '.packages[] | select(.manifest_path==$manifest) | "\(.name) \(.version)"')"

                      if curl -fsS "https://crates.io/api/v1/crates/${NAME}/${VERSION}" >/dev/null; then
                          echo "crate ${NAME} v${VERSION} already published; skipping."
                          popd >/dev/null
                          echo "::endgroup::"
                          sleep 10
                          continue
                      fi

                      cargo publish --verbose --locked
                      popd >/dev/null
                      echo "::endgroup::"

                      # Give crates.io index time to update before the next publish
                      sleep 30
                  done
